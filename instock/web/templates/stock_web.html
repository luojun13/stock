{% extends "layout/default.html" %}

{% block main_content %}
<link rel="stylesheet" href="/static/css/bootstrap-datepicker3.min.css" />
<link rel="stylesheet" href="/static/css/handsontable.min.css" />
<link rel="stylesheet" href="/static/css/ht-theme-main.min.css" />
<script type="text/javascript" src="/static/js/handsontable.full.min.js"></script>
<script src="/static/js/FileSaver.js"></script>
<script src="/static/js/bootstrap-datepicker.min.js"></script>
<script src="/static/js/bootstrap-datepicker.zh-CN.min.js"></script>

<div style="height: 100%; overflow: hidden;">
    <div class="table-header" style="width:100%; height:35px;">
        <div style="display:inline-block; float:left; height:100%;">
            <div style="display:inline-block; float:left; text-overflow:ellipsis; white-space:nowrap;">
                {{ web_module_data.name }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;日期：
            </div>
            <div style="display:inline-block; float:right;">
                <input type="hidden" id="dateid_old">
                <input type="text" value="{{ date_now }}" id="dateid" class="input-group-sm form-control date-picker">
            </div>
        </div>
        <div style="display:inline-block; float:right; height:100%;">
            <input type="button" id="resetFilter" value="重置筛选" style="background-color:#307ECC; height:100%;">
            <input type="button" id="saveExcel" value="保存Excel" style="background-color:#307ECC; height:100%;">
        </div>
    </div>
    <div id="instock-data" style="width:100%; height:calc(100% - 55px);"></div>
    <div id="statusBar" style="width:100%; height:20px;"></div>
</div>

<script type="text/javascript">
    const nameParam = $.getUrlVar('table_name');
    let dateParam = "{{ date_now }}";
    const colInfos = {% raw web_module_data.column_names %};
    let hotInstance;
    console.log(colInfos);
    $(document).ready(function () {
        initHot();
        initEvent();
        initDatePicker();

        // Resize observer for dynamic resizing
        const elem = document.querySelector('#instock-data');
        let prevWidth;
        new ResizeObserver(changes => {
            for (const change of changes) {
                if (change.contentRect.width === prevWidth) return;
                hotInstance.render();
            }
        }).observe(elem);
    });

    function convertOADate(oaDate) {
        const start = new Date(1899, 11, 30); // OLE Automation Date 的起始日期
        const delta = oaDate * 24 * 60 * 60 * 1000; // 将天数转换为毫秒
        const result = new Date(start.getTime() + delta);
        return result.toISOString().split("T")[0]; // 转换为 YYYY-MM-DD 格式
    }

    function initHot() {
        const container = document.getElementById('instock-data');
        const dateParam_old = document.getElementById("dateid_old").value;
        dateParam = document.getElementById('dateid').value;

        if (dateParam_old === dateParam) return;
        document.getElementById("dateid_old").value = dateParam;

        fetch(`/instock/api_data?name=${nameParam}&date=${dateParam}`)
            .then(response => response.json())
            .then(data => {
                const columns = colInfos.map(col => ({
                    data: col.value,
                    title: col.caption,
                    type: col.type || 'text',
                    readOnly: col.readOnly || false,
                    hidden: col.value === 'date' ? true: false,
                    // 如果 col.value 是 'code'，则指定自定义渲染器
                    renderer: col.value === 'code' ? linkRenderer : undefined,
                }));
                
                hotInstance = new Handsontable(container, {
                    data: data,
                    colHeaders: true,
                    rowHeaders: true,
                    columns: columns,
                    columnSorting: true,
                    filters: true,
                    dropdownMenu: true,
                    licenseKey: 'non-commercial-and-evaluation', // Replace with your license key if needed
                    afterChange: function(changes, source) {
                        if (source === 'edit') {
                            console.log('Cell edited:', changes);
                        }
                    }
                });

                // 自定义渲染器：为代码字段添加链接
                function linkRenderer(instance, td, row, col, prop, value, cellProperties) {
                    Handsontable.renderers.TextRenderer.apply(this, arguments); // 使用默认文本渲染器
                    const link = `<a href="javascript:void(0)" class="hot-link" style="color: blue; text-decoration: underline;">${value}</a>`;
                    td.innerHTML = link;

                    // 为链接添加点击事件
                    td.querySelector(".hot-link").addEventListener("click", () => {
                        const code = instance.getDataAtRowProp(row, "code");
                        const date = instance.getDataAtRowProp(row, "date");
                        const name = instance.getDataAtRowProp(row, "name");

                        // 格式化日期
                        const formattedDate = new Date(date).toISOString().split("T")[0];

                        // 打开新链接
                        window.open(`/instock/data/indicators?code=${code}&date=${formattedDate}&name=${name}`, "_blank");
                    });
                }
                // Update status bar
                updateStatusBar();
            });
    }

    function initEvent() {
        document.getElementById('saveExcel').onclick = function () {
            const ws = XLSX.utils.aoa_to_sheet(hotInstance.getData());
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, nameParam);
            XLSX.writeFile(wb, `${nameParam}_${dateParam}.xlsx`);
        };

        document.getElementById('resetFilter').onclick = function () {
            hotInstance.clearFilter();
            updateStatusBar();
        };
    }

    function initDatePicker() {
        $(".date-picker").datepicker({
            language: 'zh-CN',
            format: "yyyy-mm-dd",
            showOtherMonths: true,
            selectOtherMonths: false,
            autoclose: true,
            todayHighlight: true,
            onSelect: function (selected, evnt) {
                initHot(); // Refresh data on date change
            }
        }).on('changeDate', function (ev) {
            initHot();
        });
    }

    function updateStatusBar() {
        const totalRows = hotInstance.countRows();
        const visibleRows = hotInstance.countVisibleRows();
        const currentRow = hotInstance.getSelected()[0][0] + 1 || 0;

        const statusBarText = `总记录/筛选记录：<b>${totalRows}</b> / <b>${visibleRows}</b> 条 - 当前位置：第 <b>${currentRow}</b> 行`;
        document.getElementById('statusBar').innerText = statusBarText;
    }
</script>
{% end %}